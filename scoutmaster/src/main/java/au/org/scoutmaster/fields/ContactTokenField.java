package au.org.scoutmaster.fields;import org.vaadin.tokenfield.TokenField;import au.org.scoutmaster.dao.ContactDao;import au.org.scoutmaster.dao.TagDao;import au.org.scoutmaster.domain.BaseEntity;import au.org.scoutmaster.domain.Contact;import au.org.scoutmaster.domain.Tag;import au.org.scoutmaster.editors.DialogListener;import au.org.scoutmaster.editors.TagEditor;import au.org.scoutmaster.filter.EntityManagerProvider;import au.org.scoutmaster.views.Selected;import com.vaadin.addon.jpacontainer.JPAContainer;import com.vaadin.addon.jpacontainer.JPAContainerFactory;import com.vaadin.ui.Button;import com.vaadin.ui.Notification;import com.vaadin.ui.VerticalLayout;public class ContactTokenField<T extends BaseEntity> extends TokenField{	private static final long serialVersionUID = 1L;	private JPAContainer<Tag> tagContainer;	private Selected<T> selected;	@SuppressWarnings("unchecked")	public ContactTokenField(Selected<T> selected, String fieldLabel, VerticalLayout layout)	{		super(fieldLabel);		tagContainer = JPAContainerFactory.make(Tag.class, EntityManagerProvider.INSTANCE.getEntityManager());		this.setStyleName(TokenField.STYLE_BUTTON_EMPHAZISED);		this.setInputPrompt("");		this.setContainerDataSource(tagContainer);		this.setConverter(Tag.class);		this.selected = selected;	}	/**	 * Called when the user hits 'enter' or the 'tab' key to indicate that they	 * have finished entering tags. The tokenId may contain one or more comma	 * separated tags or tag ids.	 * 	 * The tokenId can either be a Long in which case it is the id of an	 * existing tag entity or can be a string in which case it is the text the	 * user typed in as the token meaning that the tag does not already exist.	 */	@Override	protected void onTokenInput(Object tokenId)	{		if (tokenId instanceof String)		{			String[] tokenNames = ((String) tokenId).split(",");			for (String tokenName : tokenNames)			{				tokenName = tokenName.trim();				if (tokenName.length() > 0)				{					final TagDao daoTag = new TagDao();					final ContactDao daoContact = new ContactDao();					// Does the tag exists					Tag tag = daoTag.findByName(tokenName);					if (tag != null)					{						// refresh the contact						Contact contact = daoContact.findById(selected.getCurrent().getId());						// Now check if the Tag is already associated with the						// contact						if (daoContact.hasTag((Contact) contact, tag))							Notification									.show(getTokenCaption(tag.getId()) + " is already associated with this contact");						else						{							daoContact.attachTag((Contact) contact, tag);							daoContact.merge((Contact) contact);							this.addToken(tag.getId());						}					}					else					{						// Tag doesn't exist so lets create one.						tag = new Tag(tokenName);						TagEditor editor = new TagEditor(tag, new DialogListener<Tag>()						{							@Override							public void confirmed(Tag tag)							{								// We MUST get our own DAO as this callback will								// happen in a different thread								// to the surrounding class.								final TagDao daoTag = new TagDao();								final ContactDao daoContact = new ContactDao();								// Need to get the contact again as we are now								// using a different entity manager.								Long id = selected.getCurrent().getId();								Contact contact = daoContact.findById(id);								// user confirmed that they want to add the tag.								daoTag.persist(tag);								// As its a new tag it mustn't exist on the								// contact so add it.								daoContact.attachTag((Contact) contact, tag);								daoContact.merge((Contact) contact);								daoTag.flush();								ContactTokenField.this.addToken(tag.getId());							}							@Override							public void declined()							{								// no-op							}						});						getUI().addWindow(editor);					}				}			}		}		else		{			// The token Id is an Entity Id of type Long.			final TagDao daoTag = new TagDao();			final ContactDao daoContact = new ContactDao();			Long tagId = (Long) tokenId;			Tag tag = daoTag.findById(tagId);			if (tag != null)			{				T contact = selected.getCurrent();				// Now check if the Tag is already associated with the contact				if (daoContact.hasTag((Contact) contact, tag))				{					Notification.show(getTokenCaption(tag.getId()) + " is already associated with this contact");				}				else				{					daoContact.attachTag((Contact) contact, tag);					//daoContact.persist((Contact) contact);					this.addToken(tag.getId());				}			}			else				throw new IllegalStateException("Tag with id=" + tagId + " is missing from db.");		}	}	@Override	protected void rememberToken(String tokenId)	{		String[] tokens = ((String) tokenId).split(",");		for (String token : tokens)		{			token = token.trim();			if (token.length() > 0)			{				super.rememberToken(token);			}		}	}	// custom caption + style if not in 'address book'	protected void configureTokenButton(Object tokenId, Button button)	{		// super.configureTokenButton(tokenId, button);		// custom caption		if (tokenId instanceof Tag)		{			Tag tag = (Tag) tokenId;			button.setCaption(tag.getName() + " x");			button.setIcon(getTokenIcon(tokenId));			button.setDescription("Click to remove");			// width			// button.setWidth("100%");			button.addStyleName(TokenField.STYLE_TOKENFIELD);		}		else if (tokenId instanceof Long)		{			Long tagid = (Long) tokenId;			TagDao daoTag = new TagDao();			Tag tag = daoTag.findById(tagid);			button.setCaption(tag.getName() + " x");			button.setIcon(getTokenIcon(tokenId));			button.setDescription("Click to remove");			// width			// button.setWidth("100%");			button.addStyleName(TokenField.STYLE_BUTTON_EMPHAZISED);		}		else			throw new IllegalArgumentException("Expected tokenId to be a Tag instead found a "					+ tokenId.getClass().getName());		// button.setStyleName(Reindeer.BUTTON_LINK);	}	/**	 * The users has clicked the token which we treat as a delete.	 */	@Override	protected void onTokenClick(Object tokenId)	{		ContactDao daoContact = new ContactDao();		// get a fresh copy.		Contact contact = daoContact.findById(selected.getCurrent().getId());		daoContact.detachTag(contact, (Tag) tokenId);		daoContact.merge(contact);		super.onTokenClick(tokenId);	}}